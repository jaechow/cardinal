<h1>cmpi_lookup APIKey Signature</h1>

![php](https://img.shields.io/badge/PHP-777BB4?style=for-the-badge&logo=php&logoColor=white)
![Watchers](https://img.shields.io/github/watchers/jaechow/cardinal.svg)

__Contents:__

<p align="center">
    <a href="#apikey-signature-introduction">Introduction</a> •
    <a href="#generating-a-timestamp">Generating a Timestamp</a> •
    <a href="#generating-a-signature-value">Generating a Signature</a> •
    <a href="#testing-apikey-signature">Testing APIKey Signature</a>
</p>

## APIKey Signature Introduction ##

Centinel now supports a more secure means of submitting requests using a combination of an API Key and the current timestamp.  This new method replaces the need to include: `MerchantId`, `ProcessorId` and `TransactionPwd` in the lookup and authenticate requests.  Instead, the lookup and authenticate requests will contain: `Algorithm`, `Identifier`, `OrgUnit`, `Signature` and `Timestamp`.

>NOTE: Authenticating to Centinel with APIKey Signature on the lookup requires also authententicating with APIKey Signature on the authenticate request.

| Field Name | Description | Required |
| :-- | :-- | :--: |
| Algorithm | The hash algorithm that was used to generate the Signature for the request.<br>__Possible Values:__<br>`SHA-256`<br>`SHA-512` | O |
| Identifier | The unique identifier representing the API Key being used to generate the Signature that is specified on the request. This value will be provided by Cardinal at the time the API Key is generated. | O |
| OrgUnit | The unique organizational unit for which the request is being processed for. Each merchant within the system will be assigned a unique OrgUnit value by Cardinal. | O |
| Signature | The signature for the request being submitted. This value is generated by hashing the combination of the Timestamp and the API Key then base64 encoding the result. Please see example below. | O |
| Timestamp | The unix epoch time in milliseconds for the point in time that the request is generated.<br>__Example output:__<br>`1467122891960` | O |

## Generating a Timestamp ##

Ensure that the timestamp is in proper millisecond format.

```PHP
<?php

$timestamp = round(microtime(true) * 1000);

?>
```

## Generating a Signature Value ##

The API Key Signature is generated by concatenating the Unix Epoch time in milliseconds and the API Key, hashing the concatenated value then base64 encoding the result.
For Example:

```PHP
<?php

$timestamp = round(microtime(true) * 1000);
$apiKey = '13f1fd1b-ab2d-4c1f-8e2c-ca61878f2a44';

# Now, concatenate the two like:
$preHash = $timestamp.$apiKey;

# Next, hash the concatenated value.
# For this example let's use the sha256 algorithm:
$hashed = hash("sha256", $preHash, true);

# Last, base64 encode the result:
$signature = base64_encode($hashed);

?>
```

## Testing APIKey Signature ##

The following example will help provide a conceptual demonstration of the cmpi_lookup with APIKey Signature and its complimentary fields

```PHP
<?php
header('Content-Type: text/plain');
$Timestamp = round(microtime(true) * 1000);
$ApiKey = '754be3dc-10b7-471f-af31-f20ce12b9ec1';
$ApiId = '582e0a2033fadd1260f990f6';
$OrgUnit = '582be9deda52932a946c45c4';
$preHash = $timestamp.$apiKey;
$hashed = hash("sha256", $preHash, true);
$Signature = base64_encode($hashed);
$cmpi_lookup = <<<XML
<CardinalMPI>
    <Algorithm>SHA-256</Algorithm>
    <Amount>12345</Amount>
    <BillAddrPostCode>44060</BillAddrPostCode>
    <BillAddrState>OH</BillAddrState>
    <BillingAddress1>8100 Tyler Blvd</BillingAddress1>
    <BillingAddress2></BillingAddress2>
    <BillingCity>Mentor</BillingCity>
    <BillingCountryCode>840</BillingCountryCode>
    <BillingFirstName>John</BillingFirstName>
    <BillingFullName>John Doe</BillingFullName>
    <BillingLastName>Doe</BillingLastName>
    <BillingPostalCode>44060</BillingPostalCode>
    <BillingState>OH</BillingState>
    <BrowserColorDepth>32</BrowserColorDepth>
    <BrowserHeader>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</BrowserHeader>
    <BrowserHeader>text/html,application/xhtml+xml,application/xml;q=0.9,</BrowserHeader>
    <BrowserJavaEnabled>true</BrowserJavaEnabled>
    <BrowserLanguage>English</BrowserLanguage>
    <BrowserScreenHeight>980</BrowserScreenHeight>
    <BrowserScreenWidth>1080</BrowserScreenWidth>
    <BrowserTimeZone>25200</BrowserTimeZone>
    <CardExpMonth>02</CardExpMonth>
    <CardExpYear>2024</CardExpYear>
    <CardNumber>4000000000001092</CardNumber>
    <CurrencyCode>840</CurrencyCode>
    <DFReferenceId>c17dea31-9cf6-0c1b8f2d3c5</DFReferenceId>
    <DeviceChannel>browser</DeviceChannel>
    <Email>cardinal.mobile.test@gmail.com</Email>
    <IPAddress>67.17.219.20</IPAddress>
    <Identifier>$ApiId</Identifier>
    <MsgType>cmpi_lookup</MsgType>
    <OrderNumber>order-0001</OrderNumber>
    <OrgUnit>$OrgUnit</OrgUnit>
    <ShippingAddress1>8100 Tyler Blvd</ShippingAddress1>
    <ShippingAddress2></ShippingAddress2>
    <ShippingCity>44060</ShippingCity>
    <ShippingCountryCode>840</ShippingCountryCode>
    <ShippingPostalCode>44060</ShippingPostalCode>
    <ShippingState>OH</ShippingState>
    <Signature>$Signature</Signature>
    <Timestamp>$Timestamp</Timestamp>
    <TransactionType>C</TransactionType>
    <UserAgent>Mozilla/5.0 (Windows NT 6.1; WOW64; rv:30.0) Gecko/20100101 Firefox/30.0</UserAgent>
    <Version>1.7</Version>
</CardinalMPI>
XML;

$ch = curl_init();

curl_setopt($ch, CURLOPT_URL,"https://centineltest.cardinalcommerce.com/maps/txns.asp");
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, 'cmpi_msg='."\n".$cmpi_lookup."\n");
curl_setopt($ch, CURLOPT_TIMEOUT, 10);
curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLINFO_HEADER_OUT, 1);

$result = curl_exec($ch);
curl_close ($ch);
echo $result;
?>
```
